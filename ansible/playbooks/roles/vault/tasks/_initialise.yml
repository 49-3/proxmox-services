---
- name: Vérifier si vault-1 est initialisé
  shell: |
    export VAULT_ADDR="http://{{ hostvars['vault-1']['ansible_' + vault_network_interface]['ipv4']['address'] }}:{{ vault_api_port }}"
    vault status | grep Initialized | awk '{print $2}'
  args:
    executable: /bin/bash
  register: vault1_initialized
  delegate_to: vault-1
  run_once: true

- name: Vérifier si vault-2 est initialisé
  shell: |
    export VAULT_ADDR="http://{{ hostvars['vault-2']['ansible_' + vault_network_interface]['ipv4']['address'] }}:{{ vault_api_port }}"
    vault status | grep Initialized | awk '{print $2}'
  args:
    executable: /bin/bash
  register: vault2_initialized
  delegate_to: vault-2
  run_once: true

- name: Initialiser Vault sur vault-1 si nécessaire
  block:
    - name: Initialiser Vault sur vault-1
      shell: |
        export VAULT_ADDR="http://{{ hostvars['vault-1']['ansible_' + vault_network_interface]['ipv4']['address'] }}:{{ vault_api_port }}"
        vault operator init -key-shares={{ key_amount }} -key-threshold={{ key_min_to_unseal }} > /etc/vault.d/init.file
      args:
        executable: /bin/bash
      delegate_to: vault-1
      run_once: true
    - name: Extraire les clés unseal dans unseal_keys.txt
      shell: |
        grep 'Unseal Key' /etc/vault.d/init.file | awk '{print $4}' > {{ secrets_dir }}/vault/unseal_keys.txt
      delegate_to: vault-1
      run_once: true
    - name: Extraire le master token dans vault_token.txt
      shell: |
        grep 'Initial Root Token:' /etc/vault.d/init.file | awk '{print $4}' > {{ secrets_dir }}/vault/vault_token.txt
      delegate_to: vault-1
      run_once: true
  when: vault1_initialized.stdout != "true"
  register: is_init_now

- name: Download files from vault-1 to deploy
  synchronize:
    src: "{{ item }}"
    dest: "{{ secrets_dir }}/vault"
    mode: pull
    delegate_to: deploy
  with_items:
    - "/etc/vault.d/init.file"
    - "/etc/vault.d/unseal_keys.txt"
    - "/etc/vault.d/vault_token.txt"
  when:
    - is_init_now.changed
    - inventory_hostname == "vault-1"
  run_once: true
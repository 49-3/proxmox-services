---
# playbooks/roles/vault_apprle_setup/tasks/_pki_setup.yml

- name: Vérifier si le moteur PKI est déjà activé
  shell: |
    vault secrets list | grep pki/ | wc -l
  register: pki_status
  environment:
    VAULT_TOKEN: "{{ vault_parent_token.stdout }}"
  changed_when: false
  when:
    - active_vault_host is defined

- name: Display Pki status
  debug:
    msg: >
      Pki is {{ 'enabled' if pki_status.stdout == "1" else 'not enabled' }} in Vault
  when: active_vault_host is defined

- name: Activer le moteur PKI sur Vault actif si non activé
  command: >
    vault secrets enable -path=pki pki
  when:
    - active_vault_host is defined
    - pki_status.stdout == "0"
  environment:
    VAULT_TOKEN: "{{ vault_parent_token.stdout }}"
  register: pki_enable_output

- name: Pause de 5s
  command: sleep 5
  run_once: true

- name: Configurer le TTL et le maximum TTL pour le moteur PKI
  command: >
    vault write pki/config/urls
      issuing_certificates="{{ vault_addr }}/v1/pki/ca"
      crl_distribution_points="{{ vault_addr }}/v1/pki/crl"
  when:
    - active_vault_host is defined
    - pki_status.stdout == "0"
  environment:
    VAULT_TOKEN: "{{ vault_parent_token.stdout }}"

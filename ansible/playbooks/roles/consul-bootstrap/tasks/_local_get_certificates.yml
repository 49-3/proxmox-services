---
- name: Generate tls dir
  file:
    path: "{{ consul_local_tls_dir }}"
    state: directory
    mode: 0750
  delegate_to: localhost
  run_once: true
  become: no

- name: Check if consul-agent-ca.pem exist
  stat:
    path: "{{ consul_config_dir }}/certs/consul-agent-ca.pem"
  register: consul_agent_ca

- name: Get certificate from consul-1
  synchronize:
    src: "{{ item }}"
    dest: "{{ consul_local_tls_dir }}"
    mode: pull
  with_items:
    - "{{ consul_config_dir }}/certs/consul-agent-ca.pem"
    - "{{ consul_config_dir }}/certs/consul-agent-ca-key.pem"
    - "{{ consul_config_dir }}/certs/dc1-server-consul-0.pem"
    - "{{ consul_config_dir }}/certs/dc1-server-consul-0-key.pem"
    - "{{ consul_config_dir }}/certs/dc1-server-consul-1.pem"
    - "{{ consul_config_dir }}/certs/dc1-server-consul-1-key.pem"
    - "{{ consul_config_dir }}/certs/dc1-server-consul-2.pem"
    - "{{ consul_config_dir }}/certs/dc1-server-consul-2-key.pem"
  when: consul_agent_ca.stat.exists

- name: Remove certs folder
  ansible.builtin.file:
    path: "{{ consul_config_dir }}/certs"
    state: absent
  when: consul_agent_ca.stat.exists
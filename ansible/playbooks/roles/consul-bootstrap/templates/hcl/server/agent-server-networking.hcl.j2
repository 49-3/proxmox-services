{% set comma = joiner(",") %}
# -----------------------------+
# agent-server-networking.hcl  |
# -----------------------------+

# Enable service mesh
connect {
  enabled = true
}

# Addresses and ports
client_addr = "127.0.0.1"

addresses {
  grpc = "127.0.0.1"
  grpc_tls = "127.0.0.1"
  http = "0.0.0.0"
  https = "0.0.0.0"
  # dns = "127.0.0.1"
  dns = "0.0.0.0"
}

ports {
  http        = 8500
  https       = 8443
  grpc        = 8502
  # grpc        = -1
  grpc_tls    = 8503
  # grpc_tls  = -1
  dns         = 8600
}

# Join other Consul agents
retry_join = [
    {%- for host in consul_ansible_bootstrap_group -%}
    {{ comma() }}"{{ hostvars[host]['ansible_'+consul_network_interface]['ipv4']['address'] }}"
    {%- endfor -%}
]